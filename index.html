<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Reproductor Mejorado</title>
  <style>
    /* Estilos b√°sicos */
    body {
      font-family: sans-serif;
      margin: 20px;
    }
    h1 {
      margin-bottom: 10px;
    }
    /* Contenedor de controles (no se modifica la estructura ni los botones) */
    #controls {
      margin: 10px 0;
    }
    button {
      margin-right: 10px;
      padding: 5px 10px;
    }
    
    /* Listado de pistas */
    #playlist {
      list-style: none;
      padding: 0;
      margin: 0;
    }
    #playlist li {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 5px;
      border-bottom: 1px solid #ccc;
      cursor: pointer;
    }
    /* (Puntos 4 y 6) Para que nombres largos se trunquen de forma responsiva con puntos suspensivos  
       Se usa un ancho m√°ximo relativo para que se ajuste seg√∫n el tama√±o */
    .track-info {
      overflow: hidden;
      white-space: nowrap;
      text-overflow: ellipsis;
      max-width: calc(100% - 40px); /* Se reserva espacio para el √≠cono de borrar */
    }
    .trashIcon {
      margin-left: 10px;
      cursor: pointer;
    }
    .active {
      background-color: #ddd;
    }
  </style>
</head>
<body>
  <h1>Reproductor Mejorado</h1>
  
  <!-- Contenedor del reproductor: Se incluye un elemento audio para pistas locales
       y un contenedor para videos de YouTube. -->
  <div id="playerContainer">
    <audio id="localPlayer" controls style="display: none;"></audio>
    <div id="youtubePlayerContainer" style="display: none;"></div>
  </div>
  
  <!-- Controles (respetando la estructura y botones originales) -->
  <div id="controls">
    <button id="prevBtn">Anterior</button>
    <button id="playPauseBtn">Play</button>
    <button id="nextBtn">Siguiente</button>
    <button id="shuffleBtn">Shuffle Off</button>
  </div>
  
  <!-- Listado de pistas -->
  <ul id="playlist"></ul>
  
  <!-- Se carga la API de YouTube (necesaria para la integraci√≥n de Media Session y controles en el mini reproductor) -->
  <script src="https://www.youtube.com/iframe_api"></script>
  <script>
    /****************************
     * Variables Globales
     ****************************/
    // Playlist con valores de ejemplo (placeholders).  
    // Reemplaza las rutas o IDs por los tuyos; aqu√≠ no se usan links reales.
    let playlist = [
      // Pista 1: Archivo local (coloca aqu√≠ la ruta de tu audio)
      { 
        type: 'local', 
        name: 'Pista 1 - Archivo Local', 
        url: 'ruta/a/tu/audio1.mp3', 
        artist: 'Artista 1', 
        title: 'T√≠tulo 1' 
      },
      // Pista 2: Video de YouTube. Reemplaza "TU_ID_DE_YOUTUBE" por tu ID (no se usa link real)
      { 
        type: 'youtube', 
        name: 'Pista 2 - Video de YouTube', 
        url: 'TU_ID_DE_YOUTUBE', 
        artist: 'Artista YT', 
        title: 'T√≠tulo YT' 
      },
      // Pista 3: Pista local con nombre muy extenso para probar el truncamiento
      { 
        type: 'local', 
        name: 'Pista 3 - Archivo Local con nombre muy extenso que debe truncarse al mostrarse en el listado', 
        url: 'ruta/a/tu/audio2.mp3', 
        artist: 'Artista 3', 
        title: 'T√≠tulo 3' 
      }
    ];
    
    let currentIndex = 0;
    let shuffleMode = false;
    let recentHistory = [];  // (Punto 1) Historial para evitar repetir hasta que se hayan reproducido 6 pistas distintas
    let userPaused = false;  // Flag para distinguir pausas intencionadas por el usuario
    
    // Referencias a elementos DOM
    const playlistUI = document.getElementById('playlist');
    const playPauseBtn = document.getElementById('playPauseBtn');
    const prevBtn = document.getElementById('prevBtn');
    const nextBtn = document.getElementById('nextBtn');
    const shuffleBtn = document.getElementById('shuffleBtn');
    const localPlayer = document.getElementById('localPlayer');
    const youtubePlayerContainer = document.getElementById('youtubePlayerContainer');
    
    let youtubePlayer = null; // Se inicializa mediante la API de YouTube
    
    /************************************
     * (Punto 3) Integraci√≥n con Media Session API
     * Se actualiza la metadata para que el mini reproductor muestre
     * informaci√≥n (artista y t√≠tulo) y permita los controles de play, pause, anterior y siguiente.
     ************************************/
    function updateMediaSession() {
      if ('mediaSession' in navigator) {
        const track = playlist[currentIndex];
        navigator.mediaSession.metadata = new MediaMetadata({
          title: track.title || track.name,
          artist: track.artist || '',
          album: '',
          artwork: [] // Si ya se extrae artwork, se puede integrar aqu√≠
        });
        navigator.mediaSession.setActionHandler('play', playCurrentTrack);
        navigator.mediaSession.setActionHandler('pause', pauseCurrentTrack);
        navigator.mediaSession.setActionHandler('previoustrack', prevTrack);
        navigator.mediaSession.setActionHandler('nexttrack', nextTrack);
      }
    }
    
    /************************************
     * Funci√≥n para cargar la pista actual
     * Se muestra el reproductor correspondiente seg√∫n el tipo (local o YouTube)
     ************************************/
    function loadCurrentTrack() {
      const track = playlist[currentIndex];
      // Se ocultan ambos reproductores antes de mostrar el adecuado.
      localPlayer.style.display = 'none';
      youtubePlayerContainer.style.display = 'none';
      
      if (track.type === 'local') {
        localPlayer.src = track.url;
        localPlayer.style.display = 'block';
      } else if (track.type === 'youtube') {
        youtubePlayerContainer.style.display = 'block';
        if (youtubePlayer && typeof youtubePlayer.loadVideoById === 'function')
          youtubePlayer.loadVideoById(track.url);
      }
      updateMediaSession();
      updatePlaylistUI();
    }
    
    /************************************
     * Reproducci√≥n y pausa
     ************************************/
    function playCurrentTrack() {
      userPaused = false;
      const track = playlist[currentIndex];
      if (track.type === 'local') {
        localPlayer.play();
      } else if (track.type === 'youtube') {
        if (youtubePlayer && typeof youtubePlayer.playVideo === 'function')
          youtubePlayer.playVideo();
      }
      playPauseBtn.textContent = 'Pause';
    }
    
    function pauseCurrentTrack() {
      userPaused = true;
      const track = playlist[currentIndex];
      if (track.type === 'local') {
        localPlayer.pause();
      } else if (track.type === 'youtube') {
        if (youtubePlayer && typeof youtubePlayer.pauseVideo === 'function')
          youtubePlayer.pauseVideo();
      }
      playPauseBtn.textContent = 'Play';
    }
    
    /************************************
     * (Punto 1) Modo Shuffle sin repetici√≥n inmediata
     * Se obtiene un √≠ndice aleatorio de las pistas que NO sean la actual
     * ni se encuentren en el historial de las √∫ltimas 6.
     ************************************/
    function getNextShuffleIndex() {
      const allowed = [];
      playlist.forEach((_, i) => {
        if(i !== currentIndex && !recentHistory.includes(i))
          allowed.push(i);
      });
      if (allowed.length === 0) {
        // Si ya se han reproducido todas, se resetea el historial (exceptuando la actual)
        recentHistory = [];
        const all = playlist.map((_, i) => i).filter(i => i !== currentIndex);
        return all[Math.floor(Math.random()*all.length)];
      }
      return allowed[Math.floor(Math.random() * allowed.length)];
    }
    
    /************************************
     * Siguiente y anterior
     * Se tiene en cuenta el modo shuffle y se actualiza el historial
     ************************************/
    function nextTrack() {
      if(shuffleMode) {
        currentIndex = getNextShuffleIndex();
        recentHistory.push(currentIndex);
        if(recentHistory.length > 6)
          recentHistory.shift();
      } else {
        currentIndex = (currentIndex + 1) % playlist.length;
      }
      loadCurrentTrack();
      playCurrentTrack();
    }
    
    function prevTrack() {
      if(shuffleMode) {
        currentIndex = getNextShuffleIndex();
        recentHistory.push(currentIndex);
        if(recentHistory.length > 6)
          recentHistory.shift();
      } else {
        currentIndex = (currentIndex - 1 + playlist.length) % playlist.length;
      }
      loadCurrentTrack();
      playCurrentTrack();
    }
    
    /************************************
     * (Punto 2) Eliminaci√≥n de pistas
     * Si se elimina la pista actual, se detiene la reproducci√≥n y no se activa la siguiente.
     * Si es otra pista, contin√∫a la reproducci√≥n.
     ************************************/
    function removeFromPlaylist(index) {
      playlist.splice(index, 1);
      if(index === currentIndex) {
        pauseCurrentTrack();
        if(playlist.length > 0) {
          currentIndex = index % playlist.length;
          loadCurrentTrack();
        } else {
          localPlayer.pause();
          if(youtubePlayer) youtubePlayer.stopVideo();
        }
      } else if(index < currentIndex) {
        currentIndex--;
      }
      updatePlaylistUI();
    }
    
    /************************************
     * (Puntos 3 y 5) Actualizaci√≥n del listado
     * Se muestra ‚ÄúArtista ‚Äì T√≠tulo‚Äù cuando se dispone de esos datos, 
     * y se utiliza el truncamiento responsivo para los nombres largos.
     ************************************/
    function updatePlaylistUI() {
      playlistUI.innerHTML = '';
      playlist.forEach((track, i) => {
        const li = document.createElement('li');
        
        const trackInfo = document.createElement('span');
        trackInfo.className = 'track-info';
        trackInfo.textContent = (track.artist && track.title) ? 
                                (track.artist + " - " + track.title) : track.name;
        li.appendChild(trackInfo);
        
        const trash = document.createElement('span');
        trash.className = 'trashIcon';
        trash.textContent = 'üóëÔ∏è';
        trash.addEventListener('click', (e) => {
          e.stopPropagation();
          removeFromPlaylist(i);
        });
        li.appendChild(trash);
        
        li.addEventListener('click', () => {
          currentIndex = i;
          loadCurrentTrack();
          playCurrentTrack();
        });
        if(i === currentIndex)
          li.classList.add('active');
        playlistUI.appendChild(li);
      });
    }
    
    /************************************
     * Eventos de los controles
     ************************************/
    playPauseBtn.addEventListener('click', () => {
      const track = playlist[currentIndex];
      if(track.type === 'local') {
        localPlayer.paused ? playCurrentTrack() : pauseCurrentTrack();
      } else if(track.type === 'youtube') {
        playPauseBtn.textContent === 'Play' ? playCurrentTrack() : pauseCurrentTrack();
      }
    });
    prevBtn.addEventListener('click', prevTrack);
    nextBtn.addEventListener('click', nextTrack);
    shuffleBtn.addEventListener('click', () => {
      shuffleMode = !shuffleMode;
      shuffleBtn.textContent = shuffleMode ? 'Shuffle On' : 'Shuffle Off';
      recentHistory = [];
    });
    
    /************************************
     * (Integraci√≥n opcional) YouTube IFrame API
     * Para pistas de tipo YouTube, se crea el reproductor en el contenedor.
     ************************************/
    function onYouTubeIframeAPIReady() {
      youtubePlayer = new YT.Player('youtubePlayerContainer', {
        height: '200',
        width: '320',
        videoId: (playlist[currentIndex].type === 'youtube' ? playlist[currentIndex].url : ''),
        playerVars: { playsinline: 1, autoplay: 0, controls: 1 },
        events: {
          'onReady': () => {},
          'onStateChange': (event) => {
            if(event.data === YT.PlayerState.ENDED)
              nextTrack();
          }
        }
      });
    }
    
    /************************************
     * Inicializaci√≥n
     ************************************/
    loadCurrentTrack();
    updatePlaylistUI();
  </script>
</body>
</html>
